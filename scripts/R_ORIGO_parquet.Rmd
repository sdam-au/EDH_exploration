---
title: "Computing Ancient Roman mobility on the basis of Origo in ancient inscriptions"
author: "Adela Sobotkova"
date: "2023-03-23"
output: html_document
---

Visualizing origo dataset:
This script contains faceted maps of origin and destination of the people in EDH inscriptions (92,000 > 3000 placenames> 2277 successfully geocoded ones).
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)

library(sf)

library(sfarrow)
library(mapview)
```

## Get province, origo and LIST data

*What are all these datasets? Explanation is needed!*
We need the following inputs for the analysis: 

*origo dataset that contains both origo and findspot converted into numeric coordinates
*LIST with inscription data containing findspot name
*Roman province boundaries for visualisation

```{r data}

# Origo parquet of linestrings is drawn from the pleiades point geocoded on the basis of origo by Mathias and Vojtech travelling towards EDH_point generated from findspot, produced by EDH editors.
origo <- st_read_parquet("../data/origo_geo.parquet")
colnames(origo)

# Pleiades provinces data have overlapping variants without description
romanEmpire <- read_sf("../data/pleiades_regions.geojson") # not great as they collate all province changes over time without identities


# EDH provinces - the best compromise for non-overlapping provincial boundaries, from VOjtech on the basis of EDH provinces
provinceEDH <- read_sf("../data/provinces_valid_BACKUP.geojson")
st_is_valid(provinceEDH) 

# provinceEDH$valid <- sf::st_is_valid(provinceEDH$geometry)
# mapview(provinceEDH, zcol = "valid")

# LIRE from https://zenodo.org/record/7966484
#LIRE <- st_read_parquet("../data/large_data/LIRE_v2-2.parquet")
LIST <- st_read_parquet("../data/large_data/LIST_v0-5.parquet")
colnames(LIST)

# Grab inscriptions that contain origo
LISTfindspot <- LIST %>% 
  filter(EDH.ID %in% origo$hd_nr) %>% 
  #filter(geometry %in% origo$edh_point)
  select(matches("EDH.ID|LIST|findspot|Lat|Long|^status")) %>% 
  select(-matches("certainty")) %>% 
  relocate(c(status,status_notation), .after = Latitude)

LISTfindspot

# paths <- st_read_parquet("../data/origo_linepoints_gdf.parquet")
```


## Birth locations geocoded in the *origo* column

Birth locations in the "origo" attribute were geocoded on the basis of 'domicile' expressed in the texts of the EDH dataset with expressions such as ex domo, ex natio, etc.. This field is unstructured text and suffers from ambiquity, incompleteness, spelling inconsistency and varied levels of granularity. It was first automatically (30% worked) and later manually geocoded (90% of the remaining 70%).

This chunk investigates the frequency and uniqueness of placenames in the origo column as well as their spatial and nomical overlap. While we have 2277 people with geocodable origo, they are named on 1951 inscriptions, mention 1083 placenames, which we have traced (with more or less certainty) to 663 unique physical locations. WHen geocoding, ca 76% of locations are geocoded with certainty, 12% have multiple good variants, 7% are uncertain and 5% represent a wild guess. 
```{r}
# Total amount of people with origo
dim(origo) # 2277 records
head(origo)

# Unique inscriptions (should be lower than 2277 as some have multiple people on an inscription)
origo %>% 
  group_by(hd_nr) %>% 
  tally()
# 1951

# Unique birth locations by coordinates
origo %>% 
  group_by(pleiades_Latitude, pleiades_Longitude) %>% 
  tally()
# 663


# Unique birth locations by origo placename
origo %>% 
  group_by(origo_clean) %>% 
  tally()
# 1083

# Unique pleiades title on origo
origo %>% 
  group_by(pleiades_title) %>% 
  tally()
# 681

# Certainty of origo geocoding
origo %>% 
  group_by(Certainty) %>% 
  tally() %>% 
  mutate(pctCertain = round(n/2277 *100, 2))
  
origo <- origo %>% 
  mutate(certainty = case_when(
   Certainty == "certain" ~ "certain",
   Certainty == "uncertain (name could be interpreted differently)" ~ "uncertain",
   Certainty == "uncertain (another good variant exists)" ~ "uncertain",
   Certainty == "uncertainty is in the latlong source"  ~ "uncertain",
   Certainty == "wild guess" ~ "wild guess"))

# Certainty of origo geocoding
origo %>% 
  group_by(certainty) %>% 
  tally() %>% 
  mutate(pctCertain = round(n/2277 *100, 2))
```

## Death locations
Death locations are represented by findspot in edh_point attribute. BUT WE ARE MISSING FIND SPOT NAMES in origo, so must grab them from LISTfindspot !! See spatial streamlining below
```{r}
colnames(origo)

# Unique death locations
nrow(origo) - length(which(duplicated(origo$edh_point)))

# only 484 unique destinations for all the travelers
```

## Spatial Data Streamlining
Create two point simple features using the point columns in origo. Call origin birthplace coordinates and deathplace deathplace
```{r spatialize death-and-birthplaces}

names(origo) # edh point is the active geometry
names(origo)[14:19] <- c("1BCE", "1CE", "2CE", "3CE", "4CE", "5CE")
deathplace <- origo %>%
  st_as_sf() %>% 
  st_set_crs(4326) %>% #mapview(zcol = "certainty")
  #st_join(LISTfindspot) %>% 
  st_transform(3035) %>% 
  # add findspot names to the spatial coordinates in deathplace
  full_join(st_drop_geometry(LISTfindspot), by = c("hd_nr"="EDH.ID")) 

birthplace <- origo %>%  # switching active geometry to ori
  st_drop_geometry() %>% 
  st_as_sf(coords = c("pleiades_Longitude","pleiades_Latitude"), crs = 4326)  %>% 
  st_transform(3035)

birthplace$origo_point

origo$edh_point # no CRS
deathplace$geometry # is NULL
deathplace$edh_point # contains data
```




### Check province and origo alignment: projection and validity
```{r}
# edh province polygons need clean up - NOT FINISHED
st_crs(provinceEDH) == st_crs(birthplace)
st_crs(provinceEDH) == st_crs(deathplace)

st_is_valid(provinceEDH)

### Province centroids
province_centroid <- st_centroid(provinceEDH)
```
## Visuals of birthplace certainty

```{r parquet-leaflet}

# Quick map to see if origo birth points are roughly in place

library(leaflet)

leaflet() %>%

  addTiles() %>%

  addCircles(origo$pleiades_Longitude,

             origo$pleiades_Latitude) %>%

  addPolygons(data = st_transform(provinceEDH, 4326), opacity = 0.2, color = "green")
```
```{r certainty-percent}
# Tally by certainty to see how many were easily geocoded

birthplace %>%
  group_by(certainty) %>%
  tally() %>% 
  mutate(pctGeocodingCertainty = round(n/2277 *100,1))
```


```{r origo-mapview-certainty}

# Plot the results in mapview so as to see the distribution of certainties in space  


library(mapview) 

mapview(birthplace, zcol = "certainty")
```

## Time-series
In order to create a facetted view of change over time, we need the century values (present/absent) to be in a single column, and not spread over several columns. Therefore we shall pivot the dataset from wide to longer and compress the individual century columns with T/F values into a single 'century' column with a row for every century the inscription was in existence.

### Time-series preparation : lengthening of datasets
```{r pivot-long}
# See the ~X1BCE fields in the dataset which indicate presence/absence in a given century
names(origo)

unique(origo$certainty)

# Wrangle the origo linestring data into a long dataset centered on deathplace

deathplace_long <- deathplace %>%  
  select(-origo_line) %>% 
  pivot_longer(cols = X1BCE:X5CE,  # take values from columns and write through True/False
               names_to = "century",
               values_to = "century_logical") %>% 
  filter(century_logical == TRUE)


# Repeat for origo_point geometry into a long dataset centered on birthplace

birthplace_long <- birthplace %>%  
  select(-origo_line) %>% 
  pivot_longer(cols = X1BCE:X5CE, 
               names_to = "century",
               values_to = "century_logical") %>% 
  filter(century_logical == TRUE)

```

### Death- and birth-place maps by magnitude of persons leaving/arriving through time

using findspot_ancient_clean and pleiades_title for death and birthplace respectively
```{r deathplace-map-time}
# add back findspot_ancient_clean  from LISTfindspot

deathplace_cntime <- deathplace_long %>% 
  select(findspot_ancient_clean, findspot_modern_clean, century) %>% 
  #filter(Certainty == "certain") %>% 
  group_by(century) %>% 
  count(findspot_ancient_clean) %>% 
  mutate(count_log = log10(n))


deathtime_map <- tm_shape(deathplace_cntime) +
  tm_facets(by = "century",
           ncol=2, nrow = 3
            )+
  tm_dots(size = "n")+
  tm_shape(provinceEDH$geometry)+
  tm_borders(alpha = 0.7)+
  tm_layout(main.title = "Deathplaces through centuries",
             legend.outside = F)
  
deathtime_map

tmap_save(deathtime_map, "../figures/deathplacemap.png", width = 15, height = 21, units = "cm")

#tmap_save(deathtime_map, "../figures/deathplacemap.html")
 
```

```{r birthplace-map-time}
# work with pleiades title in birthplace data

birthplace_cntime <- birthplace_long %>% 
  select(pleiades_title, Certainty, century) %>% 
  filter(Certainty == "certain") %>% 
  group_by(century) %>% 
  count(pleiades_title) %>% 
  mutate(count = log10(n))


birthtime_map <- tm_shape(birthplace_cntime) +
  tm_facets(by = "century",
           ncol=2, nrow = 3
            )+
  tm_dots(size = "n")+
  tm_shape(provinceEDH$geometry)+
  tm_borders(alpha = 0.7)+
  tm_layout(main.title = "Birthplaces through centuries", 
            legend.outside = F)
  
birthtime_map

tmap_save(birthtime_map, "../figures/birthplacemap.png", width = 15, height = 21, units = "cm")

#tmap_save(birthtime_map, "../figures/birthplacemap.html")

  

```



### Time-series on origin / birth place

```{r}
# Use timeseries century column as a facet in tmaps
library(tmap)
tmap_options(limits = c(facets.view = 6)) # we want to view 5 periods
tmap_options(check.and.fix = TRUE)
tmap_mode(mode = "view" )

tm_shape(birthplace_long) +
  tm_facets(by = "century",
                ncol=2, nrow = 3)+
  tm_dots("certainty")+
  tm_shape(provinceEDH$geometry)+
  tm_borders(alpha = 0.7)+
  tm_layout(main.title = "Birthplaces of moving people by century",
            legend.outside = F)

```


### Time-series on destination / death place


```{r}
# Use it as a facet in tmaps
library(tmap)
tmap_options(limits = c(facets.view = 6)) # we want to view 5 periods
tmap_options(check.and.fix = TRUE)
tmap_mode(mode = "view" )

tm_shape(deathplace_long) +
  tm_facets(by = "century",
         
            ncol=2, nrow = 3)+
  tm_dots("certainty",
             palette = "magma")+
  tm_shape(provinceEDH)+
  tm_borders(col = "grey",
             alpha = 0.7)+
  tm_layout(main.title = "Final destination of movement",
            legend.outside = TRUE)
```

## Total travellers across centuries

```{r travelrs-kable}
colnames(deathplace)
library(janitor)

total_travelers <- deathplace %>%
  st_drop_geometry() %>% 
  select(id, X1BCE:X5CE) %>%
  mutate_if(is.logical,as.numeric) %>% 
  adorn_totals("row", name = "Total_Travelers") %>% 
  slice(2278)
  

library(kableExtra)

knitr::kable(total_travelers, col.names = c("Century","1BCE", "1CE", "2CE", "3CE", "4CE", "5CE"),  align = "lcccccc", caption = "Traveler volume by century.") %>% 
    kable_styling(latex_options = "striped")


```



## Birth and death province and place statistics
Let's create some summaries of most frequent birth and death places
```{r b-d-summaries}
## Deathplace and Birthplace stats
deathplace_anc_smr <- deathplace %>% 
  st_drop_geometry() %>% 
  select(findspot_ancient_clean) %>% 
  group_by(findspot_ancient_clean) %>% 
  tally() %>% 
  arrange(desc(n))

deathplace_mod_smr <- deathplace %>% 
  st_drop_geometry() %>% 
  select(findspot_modern_clean) %>% 
  group_by(findspot_modern_clean) %>% 
  tally() %>% 
  arrange(desc(n))

death_smr <- deathplace %>% 
  st_join(provinceEDH, join = st_intersects, left = TRUE) %>% 
  st_drop_geometry() %>% 
  select(province) %>% 
  group_by(province) %>% 
  tally() %>% 
  arrange(desc(n))

## Birthplace stats
birth_smr <- birthplace %>%
  st_join(provinceEDH, join = st_intersects, left = TRUE) %>% 
  st_drop_geometry() %>% 
  select( province) %>% 
  group_by(province) %>% 
  tally() %>% 
  arrange(desc(n))

birth_anc_smr <- birthplace %>%
  st_drop_geometry() %>% 
  select(pleiades_title) %>% 
  group_by(pleiades_title) %>% 
  tally() %>% 
  arrange(desc(n))

birth_smr
death_smr

#write.csv(birth_smr, "../output_data/birthprovinces.csv")
#write.csv(death_smr, "../output_data/deathprovinces.csv")
#write.csv(birth_anc_smr, "../output_data/birthplacesanc.csv")
#write.csv(deathplace_anc_smr, "../output_data/deathplacesanc.csv")
#write.csv(deathplace_mod_smr, "../output_data/deathplacesmod.csv")
```

## Birth and death provinces' names in origo and province centroid
Here we attach birth and death province summaries to the origo data and generate summaries of province flow per province centroid.
```{r b-d-prov-origo}
birthplace_prov <- birthplace %>% 
  st_join(provinceEDH, join = st_intersects, left = TRUE)
colnames(birthplace_prov)
deathplace_prov <- deathplace %>% 
  st_join(provinceEDH, join = st_intersects, left = TRUE)


province_flow_centroid <- province_centroid %>% 
  left_join(birth_smr, by = "province") %>% 
  rename(birth_prov = n) %>% 
  left_join(death_smr, by = "province") %>% 
  rename(death_prov = n) 

province_centroid
province_flow_centroid # this may need to be done in a long format for centuries
```

## Sync maps of birth and deathplaces - province centroids

```{r}
library(mapview)
library(leafsync)

#mapview(province_flow_centroid, cex= "birth_prov")

map_origo <- mapview(province_flow_centroid, 
          map.types = "OpenStreetMap", 
        col.regions = "#940000", 
        color = "white", 
        cex = "birth_prov",
        legend = TRUE, 
        layer.name = "Birthplaces",
        homebutton = FALSE, lwd = 0.5) 


map_dest <- mapview(province_flow_centroid, 
          map.types = "OpenStreetMap", 
        col.regions = "#940000", 
        color = "white", 
        cex = "death_prov",
        legend = TRUE, 
        layer.name = "Deathplaces",
        homebutton = FALSE, lwd = 0.5)


sync(map_origo, map_dest) # maps need to be mapview based not tm_shape based
```


## Sync maps of birth and deathplaces - province polygons
Add stats to provinces and then create chloropleth maps arranging birth against death plot
```{r add-d-b-data-to-province-poly}
# we add summary data on deaths and births by province to province polygons
provinceEDH <- provinceEDH %>% 
  left_join(death_sum, by = "province") %>% 
  rename(death_sum = n) %>% 
  left_join(birth_sum, by = "province") %>% 
  rename(birth_sum = n)
```

```{r tmap-d-b-province-poly}
birth <- mapview(provinceEDH, zcol = "birth_sum")
death <- mapview(provinceEDH, zcol = "death_sum")


library(leafsync)
sync(birth, death)

b_prov <- tm_shape(provinceEDH)+
  tm_polygons("birth_sum")
d_prov <- tm_shape(provinceEDH)+
  tm_polygons("death_sum")

tmap_arrange(b_prov,d_prov, ncol = 2)
```



## Distances
## Option A: Reuse Vojtech's linestrings

```{r Vojtech-lines}
# Create linestrings sf from Vojtech's columns

lines <- origo$origo_line %>% 
  st_sf() %>% 
  st_set_crs(4326)
  # works just fine
colnames(origo)

# Connect the linestrings back with birthplace and deathplace data from origo and LISTfindspot 
b_prov <- birthplace_prov[c("hd_nr", "province")] %>% st_drop_geometry()
d_prov <- deathplace_prov[c("hd_nr", "province")] %>% st_drop_geometry()
write.csv(b_prov[duplicated(b_prov$hd_nr),], "../output_data/checkbprovforduplicates.csv")
write.csv(d_prov[duplicated(d_prov$hd_nr),], "../output_data/checkdprovforduplicates.csv")


lines <- cbind(lines, origo[,c(1:9,11:19,24)] %>% st_drop_geometry()) %>% 
  full_join(st_drop_geometry(LISTfindspot), by = c("hd_nr"="EDH.ID")) 

# Quick check
mapview(lines, zcol = "certainty")

# Calculate geodetic distance because continent scale
lines$length_m <- st_length(lines)  # geodetic distance

# Get rid of units and create kms
lines$length_km <- unclass(lines$length_m)/1000  

```
## Histogram of distances by origo certainty
```{r}
# Histogram of distances
ggplot(lines, aes(x = length_km))+
  geom_histogram(bins = 100, aes(fill = certainty))+
  ggtitle(label = "Birth to death distances by birthplace geocoding certainty")+
  theme_bw()+
  theme(#legend.title=element_blank(),
        legend.position = c(.85,.75))+
  labs(x = "Distance in kms",
       y = "Persons",
       fill = "Origo coordinates")+
  geom_vline(aes(xintercept = mean(length_km)), linetype = "dashed", size = 1)

ggsave("../figures/orig_dist_certain.png", width = 8, height = 6)
```



### Trip length summary statistics
```{r}
# al trips
summary(lines$length_km)

# only certain birthplaces
summary(lines[lines$certainty == "certain",]$length_km) # 1746

lines %>% filter(certainty == "certain")
```
## Distances in a Timeseries: Break distances down by century


```{r long-lines}

# Make lines into a long dataset
colnames(lines)
lines_long <- lines %>%  
  #select(-origo_line) %>% 
  pivot_longer(cols = X1BCE:X5CE,  # take values from columns and write through True/False
               names_to = "century",
               values_to = "century_logical") %>% 
  filter(century_logical == TRUE)
colnames(lines_long)

```

```{r facetted-timeseries}
# Facetted histogram of distances through time - only certain
mean_certain <- lines_long %>% 
  st_drop_geometry() %>%
  filter(certainty == "certain") %>% 
  group_by(century) %>% 
  summarize(average = mean(length_km))

lines_long %>% 
  filter(certainty == "certain") %>% 
  ggplot(aes(x = length_km))+
  geom_histogram(bins = 100, aes(fill = certainty) )+
  geom_vline(aes(xintercept = average), mean_certain, linetype = "dashed")+
  ggtitle(label = "Life to death distance over centuries") +
  theme_bw() +
  theme(#legend.title=element_blank(),
         #legend.position = c(.88,.94)
          legend.position="none")+
  labs(x = "Distance in kms",
       y = "Number of travelers",
       fill = "Birthplace coordinates")+
  facet_grid(rows = vars(century)) 

ggsave("../figures/orig_distc_centuries.png", width = 20, units = 
        "cm")

```

```{r facet-timeseries-all}
# Facetted histogram of distances through time - all, including uncertain
mean_all <- lines_long %>% 
  st_drop_geometry() %>%
  #ilter(certainty == "certain") %>% 
  group_by(century) %>% 
  summarize(average = mean(length_km))

lines_long %>% 
  ggplot(aes(x = length_km))+
  geom_histogram(bins = 100, aes(fill = certainty) )+
  geom_vline(aes(xintercept = average), mean_all, linetype = "dashed")+
  ggtitle(label = "Life to death distance over centuries") +
  theme_bw() +
  theme(#legend.title=element_blank(),
        legend.position = c(.88,.90)
         )+
  labs(x = "Distance in kms",
       y = "Number of travelers",
       fill = "Birthplace coordinates")+
  facet_grid(rows = vars(century)) 

ggsave("../figures/orig_distall_centuries.png", width = 20, height = 20, units = 
        "cm")
```

### Cumulative Distance by century stats

```{r}
lines_long %>% 
  st_drop_geometry() %>% 
  filter(certainty == "certain") %>% 
  mutate(triplength = case_when(
    length_km < 200 ~ "short (<200km)",
    length_km < 1000 ~ "medium (200-1000km) ",
    length_km > 1000 ~ "long (1000km+)"
  )) %>% 
  group_by(century, triplength) %>% 
  summarize(total_distance = round(sum(length_km)),
            mean_distance = round(mean(length_km)),
            trips = n()) %>% 
  t()

lines_long %>% 
  st_drop_geometry() %>% 
 # filter(certainty == "certain") %>% 
  mutate(triplength = case_when(
    length_km < 200 ~ "short (<200km)",
    length_km < 1000 ~ "medium (200-1000km) ",
    length_km > 1000 ~ "long (1000km+)"
  )) %>% 
  group_by(century, triplength) %>% 
  summarize(total_distance = round(sum(length_km)),
            mean_distance = round(mean(length_km)),
            trips = n()) %>% 
  t()
```

## Barplot: Cumulative Distance by century

```{r cum-dist-certain}
options(scipen = 999)

lines_long %>% 
  st_drop_geometry() %>% 
  filter(certainty == "certain") %>% 
  mutate(triplength = case_when(
    length_km < 200 ~ "short (<200km)",
    length_km < 1000 ~ "medium (200-1000km) ",
    length_km > 1000 ~ "long (1000km+)"
  )) %>% 
  group_by(century, triplength) %>% 
  summarize(total_distance = round(sum(length_km)),
            mean_distance = round(mean(length_km)),
            trips = n()) %>% 
  ungroup() %>% 
  mutate(century = paste0(rep(c("1BCE", "1CE", "2CE", "3CE", "4CE", "5CE"),each = 3))) %>% 
  ggplot(aes(x = century, y = total_distance))+
   geom_col(aes(fill = triplength)) + 
  # geom_label(aes(label= trips)) +
    scale_fill_grey()+ # B&W version
   # geom_line(y = mean_distance, aes(color = "red")) +
  # scale_y_continuous("Total distance traveled", sec.axis= sec_axis(~ ./trips, name = "Average distance")) +
  # scale_x_continuous("Century", breaks = 1:6) +
  ggtitle("Cumulative distances over time") +
  theme_bw() +
    theme( #legend.title= element_blank(),
          legend.position = c(.85,.75))+
   labs(x = "Century",
       y = "Cumulative distance (km)",
       fill = "Trip length")

ggsave("../figures/origcert_distcum_centuriesBW.png", width = 8, height = 6)
```

all origos including uncertain ones
```{r cum-dist-all}
options(scipen = 999)

lines_long %>% 
  st_drop_geometry() %>% 
  #filter(certainty == "certain") %>% 
  mutate(triplength = case_when(
    length_km < 200 ~ "short",
    length_km < 560 ~ "medium",
    length_km > 560 ~ "long"
  )) %>% 
  group_by(century, triplength) %>% 
  summarize(total_distance = round(sum(length_km)),
            mean_distance = round(mean(length_km)),
            trips = n()) %>% 
  ungroup() %>% 
  mutate(century = paste0(rep(c("1BCE", "1CE", "2CE", "3CE", "4CE", "5CE"),each = 3))) %>% 
  ggplot(aes(x = century, y = total_distance))+
   geom_col(aes(fill = triplength)) + 
   # geom_line(y = mean_distance, aes(color = "red")) +
  # scale_y_continuous("Total distance traveled", sec.axis= sec_axis(~ ./trips, name = "Average distance")) +
  # scale_x_continuous("Century", breaks = 1:6) +
  ggtitle("Cumulative distances over time") +
  theme_bw() +
    theme( #legend.title= element_blank(),
          legend.position = c(.85,.75))+
   labs(x = "Century",
       y = "Cumulative distance (km)",
       fill = "Trip length")

ggsave("../figures/origall_distcum_centuries.png", width = 8, height = 6)
```

## Break down the distances traveled by status and gender
If we add people and inscription data back to the linestrings, we can differentiate the travel by sex, status, occupation, and other social categories. 

To add people into the origo points and linestrings we need to connect origo data to LIRE or EDH data hd_nr at least, but at best to id - the combination of EDH identifier and person identifier.
Try with LIRE people or with EDH people. 
- Currently the LIRE does not work so well.

```{r EDH-people}
# Bring in people data from EDH
# if newest does not work, use 2021 data in rds
# list_json <- jsonlite::fromJSON("../data/large_data/EDH_text_cleaned_2022-11-03.json")  
# EDH_tibble <- as_tibble(list_json)

# Rdata of 2021 json EDH tibble
EDH_tibble <- readRDS("../data/large_data/edh_2021.rds")

colnames(EDH_tibble)
EDH_tibble$id

# Select inscriptions whose number matches that in origo
EDH_origo <- EDH_tibble %>%
  filter(id %in% origo$hd_nr) # 2288 inscriptions match but have wrapped people attribute

# Select inscriptions whose number matches one in origo dataset and expand the people attribute
EDH_origo_people <- EDH_tibble %>%
  filter(id %in% origo$hd_nr) %>%  # match origo hr_nr
  dplyr::select(id, people) %>% 
  unpack(cols = c(people))  %>% 
  unnest_wider(people, simplify = F) %>% 
  unnest_longer(c(person_id,name, cognomen, nomen, supernomen, gender, praenomen, `age: years`, `age: months`, `age: days`, `age: hours`, status, occupation, tribus, origo)) 

# Find which of the expanded 4000 people have origo (should be ca 2277)
EDH_origo_people <- EDH_origo_people %>% 
  filter(!is.na(origo)) # 2288 people records in 1930 unique inscriptions
EDH_origo_people %>% group_by(id) 

# Find matching columns in lines geospatial data with EDH people
head(EDH_origo_people)
colnames(EDH_origo_people)

```

Now that we identified the columns that are shared, we can connect spatial data to personal information to learn about the status and gender of travelers
```{r}
# Create a field that matches id in lines
EDH_origo_people$newid <- paste(EDH_origo_people$id, EDH_origo_people$person_id, sep="/")

# Spatial data inspect
colnames(lines)
head(lines)

# Merge spatial and EDH origo data by person_id
lines_people <- lines %>% 
  left_join(EDH_origo_people, by=c("id" = "newid"))
  #select(matches("pleiades|origo|id|hd|X|type_of|clean_text|point|line|people"))
```

## Visualize distances traveled by status and gender
## Distance and occupation
a fraction of travelers mention their occupation, graphs are not worth publishing
```{r}
# Show how many travelers provide occupation info
ggplot(lines_people, aes(x = length_km))+
  geom_histogram(bins = 100, aes(fill = occupation))+
  ggtitle(label = "Great Circle distances from birth region to death region")+
  theme_bw()+
  labs(x = "Distance in kms",
       y = "Number of travelers")

ggsave("../figures/orig_dist_occup.png", width = 8, height = 6)


# Show occupations alone
lines_people %>% 
  filter(!is.na(occupation)) %>% 
  ggplot(aes(x = length_km))+
  geom_histogram(bins = 100)+
  ggtitle(label = "Birth to death distances for travelers with occupation (56 out of 2277)")+
  theme_bw()+
  labs(x = "Distance in kms",
       y = "Travelers with an occupation")
```

Traveling individuals rarely state their occupation. Howeer most are soldiers so the occupation is clear. The occupation of others is driven by their social status of being senators ao slaves,..
## Distance and gender
a fraction of women declare origo
```{r}
# Show breakdown of travelers distances by gender
ggplot(lines_people, aes(x = length_km))+
  geom_histogram(bins = 100, aes(fill = gender))+
  ggtitle(label = "Birth to death distances by gender")+
  theme_bw()+
  theme(legend.title=element_blank(),
        legend.position = c(.85,.75))+  # works only after theme_bw()
  labs(x = "Distance in kms",
       y = "Gendered travelers")

ggsave("../figures/orig_dist_gender.png", width = 8, height = 6)
```

```{r eval= FALSE}
# A stacked plot may be better to show if fraction of women increase inversely to distance, however we need a percent column calculated for each distance bin. Distance bins are variable so this is a moving target. ONce you decide on bins, follow this logic:

percent_gender <- lines_people %>%
    group_by(gender, distance_interval) %>%
    mutate(percent = n/sum(gender) * 100) %>%
    ungroup()

ggplot(lines_people, aes(x = length_km))+
  geom_bar(aes(fill = percent_gender))+
  ggtitle(label = "Birth to death distances by gender")+
  theme_bw()+
  labs(x = "Distance in kms",
       y = "Gendered travelers")

```

## Distance by status
```{r}
# Pull the first primary status out of the multi-valued attribute
status <- str_split_fixed(lines_people$status, ";", n=3) %>% 
  as.data.frame()

# Tie status back to lines
lines_status <- cbind(lines_people, status$V1)
colnames(lines_status)

# Clean up mising values and special characters
lines_status <- lines_status %>% 
  filter(!is.na(status)) %>% 
  mutate(status_clean = str_replace_all(string = status.V1, pattern = "\\?", replacement = "")) 

# Plot status by distance
ggplot(data = lines_status,  aes(x = length_km))+
  geom_histogram(bins = 100, aes(fill = status_clean))+
  theme_bw()+
  theme(#legend.title=element_blank(),
        legend.position = c(.75,.75))+
  labs(title = "Birth to death distances by traveler status (1477 out of 2277)",
       x = "Distance in kms",
       y = "Persons", 
       fill = "Primary status")

ggsave("../figures/orig_dist_status.png", width = 8, height = 6)
```
## Faceted plot by status
```{r}
# Plot status by distance
ggplot(data = lines_status,  aes(x = length_km))+
  geom_histogram(bins = 50, aes(fill = certainty))+
  facet_wrap(~ status_clean)+
  theme_bw()+
  theme(legend.position = "bottom")+
  labs(title = "Birth to death distances by traveler status (1477 out of 2277)",
        x = "Distance in kms",
        y = "Traveler count", 
        fill = "Origo location")

ggsave("../figures/orig_dist_occupfac.png", width = 8, height = 6)
```

## What is the status count
```{r}
lines_status %>% 
  st_drop_geometry() %>% 
  filter(!is.na(status_clean)) %>% 
  group_by(status_clean) %>% 
  count() %>% 
  mutate(log=round(log10(n),1)) %>% 
  arrange(desc(log)) %>% 
  #mutate(status_clean = reorder(status_clean, log)) %>% 
  ggplot(aes(y=status_clean, x=log, fill=status_clean)) +
  geom_col(width=0.8, stat="identity") +
  coord_cartesian(xlim=c(0,4)) +
  labs(x = "Number of instances (log10)", y = "Status category", title = "Status references in the origo data", subtitle = ggtitle(paste("n =", nrow(lines_status), "people in inscriptions"))) +
  geom_label(aes(label= n)) +
  theme_linedraw(base_size = 13) +
  theme(legend.position = "none")

ggsave("../figures/Status_origo.png", width = 8, height = 6) 
```



## Oddities and deeper explorations
```{r duplicate-prov-records}

# What are the unique provinces?
birthplace_prov %>% 
  distinct(province) %>% 
  pull(province) %>% 
  sort()


# Why are there such big cohorts in Moesia Superior?
LIST %>% 
  filter(EDH.ID== "HD032316")

# Where are migrants from in Hispania and Baetica -there seem to be a lot of villages?

birthplace_prov %>% 
  filter( province == "Baetica" | province == "Hispania Citerior"  ) %>% 
  select(province, origo_clean, pleiades_title) %>% 
  count(pleiades_title) %>% 
  #arrange(desc(n)) %>% 
  mapview(zcol = "n", cex = "n", label = "pleiades_title")

birthplace_prov %>% 
  filter(province == "Venetia et Histria (Regio X)"  ) %>% 
  select(province, origo_clean, pleiades_title) %>% 
  count(pleiades_title) %>% 
  #arrange(desc(n))  
  mapview(zcol = "n", cex = "n", label = "pleiades_title")

  
# Compare the Spanish figures with Moesia
birthplace_prov %>% 
  filter(province == "Moesia Superior"  ) %>% 
  select(province, origo_clean, pleiades_title) %>% 
  count(pleiades_title) %>% 
  arrange(desc(n))  
  mapview(zcol = "n", cex = "n", label = "pleiades_title")

  
# .. and Germany
birthplace_prov %>% 
  filter(province == "Germania Inferior"  ) %>% 
  select(province, origo_clean, pleiades_title) %>% 
  count(pleiades_title) %>% 
  arrange(desc(n))  
  mapview(zcol = "n", cex = "n", label = "pleiades_title")

```
If we compare the count of unique inscriptions from each province with the number of unique people, we see how much disparity there is in recruitment techniques - word of mouth, official recruiters, poverty or other push factors behind the sign up.
```{r}
# Count of unique inscriptions from each birth region
  
birthplace_prov %>% 
  filter( province == "Baetica" | province == "Hispania Citerior"  ) %>% 
  select(hd_nr) %>%
  distinct(hd_nr)

birthplace_prov %>% 
  filter( province == "Germania Superior" ) %>% 
  select(hd_nr) %>%
  distinct(hd_nr)

birthplace_prov %>% 
  group_by(province, hd_nr) %>% 
  tally()
  
birthplace_prov %>% 
  filter( province == "Moesia Superior" ) %>% 
  group_by(hd_nr) %>%
  tally()

```

In a single inscription from Viminacium (near modern Kostolac), over 40 individuals (soldiers and others) are mentioned in a list below dedication. So HD032316 should allocate 40 people to Moesia Superior as a deathplace, and maybe also birthplace (many are from Scupi and Remesiana, others from Salona, Montana and others). All are military with various roles mentioned, such as interpreter, guardian of arms (custos armorum), signifer, imaginifer, etc.
The signatories need not have died here, they are merely named as contributors to the dedication. So reading Viminacium as a deathplace is an exaggeration, however, they probably lived nearby.

Roma is low in the number of birth and death provinces as its name overlaps with Lazio et Histria. It is mentioned 33 and 104 times in the respective datasets. Except when the coordinates place an individual directly in Rome, it often hides behind Lazio (which comes alphabetically first) as they overlap spatially.

```{r lazio-Rome}
# What is the situation with Rome and Lazio et Histria?
birthplace_prov %>% 
   distinct(province) %>% 
   pull(province) %>% 
   sort()

birthplace_prov %>% 
  st_drop_geometry() %>% 
  filter(province == "Roma"  |  province == "Latium et Campania (Regio I)" ) %>% 
  select(province, hd_nr, id, pleiades_title) %>%
  arrange(pleiades_title) %>% 
  pull(pleiades_title) %>% table()

birthplace_prov %>% 
  filter(pleiades_title== "Roma") %>%
  distinct(id)

```
There are 32 duplicates where pleiades_title is "Roma", as the spatial origo point falls both in the polygon of Rome and Latium et Campania
There are 60 total emigrants from Latium et Campania, of whom 32 are from Rome proper, 3 from Capua and Teanum Sidicum , 2 from Praeneste, Campania and Ostia.
There are 33 migrants from the province "Roma", where 32 are from Rome proper and 1 from Forum Augusti. However, the second dataset is clearly a duplicate, caused by the overlap of the point with two polygons - one of Latium and another of Rome. If we look at *distinct* id that share the pleiades_title 'Roma', we get 32 discrete/ unique individuals.

